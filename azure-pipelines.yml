resources:
  containers:
    - container: node
      image: node:10

jobs:
  - job: build
    container: node
    steps:
      - checkout: self
        clean: true
        displayName: Checkout source
      - script: yarn config set unsafe-perm true
        displayName: Set Unsafe Perms for Yarn
      - script: yarn install --frozen-lockfile
        displayName: Install using yarn with the lockfile frozen
      - script: yarn run lerna bootstrap
        displayName: Bootstrap with lerna
  - job: publish
    dependsOn: build
    container: node
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    steps:
      - checkout: self
        clean: true
        displayName: Checkout source
      - script: echo "//registry.npmjs.org/:_authToken=$(NPM_TOKEN)" > ~/.npmrc
        displayName: Fill in auth token for NPMJS
      - script: yarn config set unsafe-perm true
        displayName: Set Unsafe Perms for Yarn
      - script: yarn install --frozen-lockfile
        displayName: Install using yarn with the lockfile frozen
      - script: yarn run lerna bootstrap --ignore @ukho/design-system
        displayName: Bootstrap with lerna
      - script: yarn run lerna publish from-package --no-git-reset --yes
        displayName: Publish to NPMJS
  - job: ghpages
    dependsOn: publish
    container: node
    condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
    steps:
      - task: InstallSSHKey@0
        inputs:
          hostName: $(knownHosts)
          sshPublicKey: $(publicKey)
          sshKeySecureFile: id_github
      - script: yarn config set unsafe-perm true
        displayName: Set Unsafe Perms for Yarn
      - script: yarn install --frozen-lockfile
        displayName: Install using yarn with the lockfile frozen
      - script: yarn run lerna bootstrap
        displayName: Bootstrap with lerna
      - script: |
          cd projects/components
          yarn run build-storybook
          cd ../site
          yarn add -D gh-pages@2.0.1
          git config user.email "pipeline@ukho.gov.uk"
          git config user.name "Azure Pipeline"
          touch dist/.nojekyll
          echo "design.ukho.dev" > dist/CNAME
          mv ../components/.out dist/storybook
          yarn run gh-pages --dotfiles --message "[skip ci] gh-pages update" --dist dist -r git@github.com:UKHO/design-system.git
